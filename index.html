<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="DEIMS-SDR Team">
    <title>DEIMS-SDR | Site Record Quality Assurance Tool</title>
	<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
	<link rel="stylesheet" href="bootstrap-4.1.3-dist/css/bootstrap.min.css">
	<script src="bootstrap-4.1.3-dist/js/bootstrap.min.js"></script>
	<script src="js/jquery-3.4.1.min.js"></script>
	<script src="js/xml2json.min.js"></script>
	<script src="js/jsts.min.js"></script>
	<script src="js/awesomplete.min.js"></script>
	<link rel="stylesheet" href="css/awesomplete.css" />
  </head>
  
  <body class="py-4">
    <div class="container">

	  <h1>DEIMS-SDR</h1>
	  <p class="lead">Site Record Quality Assurance Tool</p>
		<input id= "deims_id_text_field_box" type="text" placeholder="Type in the site name"><br><br>
		<p>Quality assessment for site record <h3 id="site_name_heading">[...]</h3></p>
		<p id="deims_id_url_container"></p>
		<table class="table">
		  <thead>
			<tr>
			  <th scope="col">Field</th>
			  <th scope="col">Comment</th>
			</tr>
		  </thead>
		  <tbody>
			<tr id="boundaries_check_row" class="table-active">
			  <td><b>Boundaries</b></td>
			  <td id="boundaries_check_result"></td>
			</tr>
			<tr id="shortname_check_row" class="table-active">
			  <td><b>Short Name</b></td>
			  <td id="shortname_check_result"></td>
			</tr>
		  </tbody>
		</table>
	  
	  <footer class="pt-4 my-md-5 pt-md-5 border-top">
        <div class="row">
          <div class="col-12 col-md">
            <small class="d-block mb-3 text-muted">Â©2020 Umweltbundesamt GmbH</small>			
          </div>
          <div class="col-6 col-md">
            <ul class="list-unstyled text-small">
			    <li><a href="https://deims.org/about">About</a></li>
				<li><a href="https://deims.org/terms">Terms</a></li>
				<li><a href="https://deims.org/imprint">Imprint</a></li>
				<li><a href="https://deims.org/privacy">Privacy</a></li>
                <li><a href="https://deims.org/contact">Contact</a></li>
            </ul>
          </div>
        </div>
      </footer>

	</div> <!-- /container -->
	</body>
</html>

<script>
	
	var autocomplete_field = document.getElementById("deims_id_text_field_box");
	var awesomplete = new Awesomplete(autocomplete_field);
	var fetch_url = "https://deims.org/geoserver/deims/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=" + "deims:deims_all_sites" + "&outputFormat=application%2Fjson";
	var site_names = [];
	var site_names_appendix = [];
	$.getJSON(fetch_url, function (data) {

		site_names.length = 0;
		site_names_appendix.length = 0;
		for (i = 0; i < data["features"].length; i++) {
			site_names.push(data["features"][i]["properties"]["name"]);
			site_names_appendix.push({
				lat: data["features"][i]["properties"]["field_coordinates_lat"],
				lon: data["features"][i]["properties"]["field_coordinates_lon"],
				deimsid: data["features"][i]["properties"]["deimsid"]
			});
		}
		awesomplete.list = site_names;

	})

	// default text for Awesomplete
	$('.default-value').each(function () {
		var $t = $(this),
			default_value = this.value;
		$t.css('color', '#929292');
		$t.focus(function () {
			if (this.value == default_value) {
				this.value = '';
				$t.css('color', 'black');
			}
		});
		$t.blur(function () {
			if ($.trim(this.value) == '') {
				$t.css('color', '#929292');
				this.value = default_value;
			}
		});
	});
	
	// event listener for Awesomplete
	Awesomplete.$('#deims_id_text_field_box').addEventListener("awesomplete-selectcomplete", function () {	
		var deims_id = site_names_appendix[site_names.indexOf(Awesomplete.$('#deims_id_text_field_box').value)]['deimsid'].substr(18);
		check_site_record(deims_id);
	});

	
	function check_site_record(deims_id){
		var json_address = "https://deims.org/api/site/" + deims_id;
			
		var x = new XMLHttpRequest();
		x.open("GET", json_address, true);
		x.onreadystatechange = function () {
			// on success, do the parsing
			if (x.readyState == 4 && x.status == 200) {
			
				var jsonObj = JSON.parse(x.responseText);
				
				document.getElementById('site_name_heading').innerHTML = jsonObj["title"]; 
				document.getElementById('deims_id_url_container').innerHTML = ' <a href="https://deims.org/' + deims_id + '">' + 'https://deims.org/' + deims_id + '</a>'; 
				
				// check boundaries
				if (jsonObj["attributes"]["geographic"]["boundaries"] == null) {
					document.getElementById('boundaries_check_result').innerHTML = '<div class="text-danger">No boundaries provided</div>';
					$('#boundaries_check_row').removeClass().addClass('table-danger');
				}
				var wkt_reader = new jsts.io.WKTReader();
				var geom = wkt_reader.read(jsonObj["attributes"]["geographic"]["boundaries"]);

				if (geom.isValid()) {
					document.getElementById('boundaries_check_result').innerHTML = '<div class="text-success">The boundaries geometry is valid.</div>';
					$('#boundaries_check_row').removeClass().addClass('table-success');
				}
				else {
					document.getElementById('boundaries_check_result').innerHTML = '<div class="text-danger">The boundaries are not valid</div>';
					$('#boundaries_check_row').removeClass().addClass('table-danger');
				}
				
				// check short name
				if (jsonObj["attributes"]["general"]["shortName"] == null) {
					document.getElementById('shortname_check_result').innerHTML = '<div class="text-danger">No short name provided</div>';
					$('#shortname_check_row').removeClass().addClass('table-danger');
				}
				else {
					if (jsonObj["attributes"]["general"]["shortName"].length > jsonObj["attributes"]["general"]["siteName"].length) {
						document.getElementById('shortname_check_result').innerHTML = '<div class="text-danger">The short name is longer than the site name.</div>';
						$('#shortname_check_row').removeClass().addClass('table-danger');
					} else if (jsonObj["attributes"]["general"]["shortName"].length == jsonObj["attributes"]["general"]["siteName"].length) {
						document.getElementById('shortname_check_result').innerHTML = '<div class="text-warning">The short name is the same length as the site name.</div>';
						$('#shortname_check_row').removeClass().addClass('table-warning');
					}
					else {
						$('#shortname_check_row').removeClass().addClass('table-success');
						document.getElementById('shortname_check_result').innerHTML = '<div class="text-success"></div>';
					}
				}
				
			}
			// if there is something wrong with the json request
			if (x.readyState == 4 && x.status == 500) {
				$.notify("The JSON record could not be loaded :(", {position:"top right"}, "error");		
				return;
			}
		  
		};
		
		x.send(null);
		
		return true;   

	}

		
</script>